name: Openport RDP Tunnel

on:
  workflow_dispatch:

jobs:
  setup-rdp-tunnel:
    runs-on: windows-latest

    steps:
    - name: Check out the repository
      uses: actions/checkout@v2

    - name: Download Openport
      run: |
        Invoke-WebRequest -Uri "https://openport.io/static/releases/Openport_2.2.1.exe" -OutFile "$env:USERPROFILE\openport.exe"

    - name: Enable RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

    - name: Create RDP User
      run: |
        net user NoahNW IloveNoah123$ /add
        net localgroup "Remote Desktop Users" NoahNW /add

    - name: Start Openport Tunnel for RDP and Display Info
      env:
        OPENPORT_AUTH_TOKEN: ${{ secrets.OPENPORT_AUTH_TOKEN }}
      run: |
        Write-Host "Starting Openport tunnel for RDP..."
        # Start Openport in the foreground and capture output
        $output = & "$env:USERPROFILE\openport.exe" tcp 3389 --token $env:OPENPORT_AUTH_TOKEN
        # Display the Openport output (should contain the public address)
        Write-Host "==== Openport Output ===="
        Write-Host $output
        # Try to extract the public address from the output (best effort)
        if ($output -match "tcp://[^\s]+") {
          $publicAddress = $matches[0]
          Write-Host "`nYour Openport public address is: $publicAddress"
        } else {
          Write-Host "`nCould not automatically extract the public address. Please check the above output."
        }
        Write-Host "`nRDP Credentials:"
        Write-Host "Username: NoahNW"
        Write-Host "Password: IloveNoah123$"
        Write-Host "`nYou can now connect using Remote Desktop!"
      shell: pwsh

    - name: Keep the GitHub Action Runner Alive
      run: |
        while ($true) { Start-Sleep -Seconds 3600 }
      shell: pwsh
