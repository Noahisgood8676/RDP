name: Windows-11-Perpetual-NoahNW

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *' # Trigger every 6 hours

jobs:
  deploy:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Restore Persistence Core
      uses: actions/download-artifact@v4
      with:
        name: NoahNW-Data
        path: C:\Users\NoahNW\SavedData
      continue-on-error: true # Ignore error on first run (when no artifact exists)

    - name: Setup Environment & Tunnel
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip
      shell: powershell

    - name: Initialize Janus Handshake
      run: .\ngrok\ngrok.exe authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
      shell: powershell

    - name: Credential Override: NoahNW
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
        # Create the custom identity
        net user NoahNW "IloveNoah123$" /add
        net localgroup administrators NoahNW /add
        # Fix for auto-login and persistence folders
        mkdir C:\Users\NoahNW\Documents -Force
        if (Test-Path C:\Users\NoahNW\SavedData) { Copy-Item -Path C:\Users\NoahNW\SavedData\* -Destination C:\Users\NoahNW\Documents -Recurse -Force }
      shell: powershell

    - name: Establish Neural Link
      run: |
        # This keeps the tunnel open for the duration
        Start-Process .\ngrok\ngrok.exe -ArgumentList "tcp 3389"
        echo "RDP Address is being generated..."
        Start-Sleep -Seconds 10
        curl http://127.0.0.1:4040/api/tunnels | jq '.tunnels[0].public_url'
        # Keep alive for 5.5 hours, then save data
        Start-Sleep -Seconds 19800 
      shell: powershell

    - name: Save-State Synchronization
      if: always() # Executes even if the job is cancelled or times out
      run: |
        Compress-Archive -Path C:\Users\NoahNW\Documents\* -DestinationPath C:\Users\NoahNW\DataBackup.zip -Force
      shell: powershell

    - name: Upload Persistence Core
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: NoahNW-Data
        path: C:\Users\NoahNW\DataBackup.zip
        retention-days: 1
